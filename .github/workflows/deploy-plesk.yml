name: Deploy to Plesk (Build on Server)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Plesk via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_URL: "https://oauth2:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        with:
          host: ${{ secrets.PLESK_HOST }}
          username: ${{ secrets.PLESK_USER }}
          key: ${{ secrets.PLESK_SSH_KEY }}
          envs: GITHUB_TOKEN,REPO_URL
          script: |
            # Configuration
            TARGET_DIR="/var/www/vhosts/dimetrics-app"

            echo "Deploying to $TARGET_DIR..."

            # Create directory if it doesn't exist
            mkdir -p $TARGET_DIR
            cd $TARGET_DIR

            # Check if it's already a git repo
            if [ -d ".git" ]; then
              echo "Pulling latest changes..."
              # Update remote URL with current token to ensure access
              git remote set-url origin $REPO_URL
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              echo "Cloning repository..."
              # Clean directory if it's not empty but not a git repo (safety first)
              if [ "$(ls -A $TARGET_DIR)" ]; then
                echo "Warning: Directory not empty. Cleaning up..."
                rm -rf *
                rm -rf .* 2>/dev/null || true
              fi
              git clone $REPO_URL .
            fi

            # Build and Start Docker Containers
            echo "Building Docker image (no-cache)..."
            docker compose build --no-cache

            echo "Starting containers..."
            docker compose up -d --remove-orphans

            echo "Cleaning up unused images..."
            docker image prune -f

            echo "Deployment finished successfully!"
